#!/usr/bin/env bash
set -e
set -u

# Get all contexts except the current one
contexts=($(kubectl config get-contexts -o name))
current_context=$(kubectl config current-context 2>/dev/null || true)

if [ ${#contexts[@]} -eq 0 ]; then
    echo "No contexts found."
    exit 1
fi

echo "Available contexts:"
echo "=================="
i=1
for context in "${contexts[@]}"; do
    if [ "$context" = "$current_context" ]; then
        echo "$i) $context (current - cannot delete)"
    else
        echo "$i) $context"
    fi
    ((i++))
done
echo "=================="
echo

# Get user selection
read -p "Enter context numbers to delete (space-separated, e.g., '1 3 5'): " selections

if [ -z "$selections" ]; then
    echo "No contexts selected."
    exit 0
fi

# Convert selections to array
selected_nums=($selections)
contexts_to_delete=()

# Collect contexts to delete
for num in "${selected_nums[@]}"; do
    if ! [[ "$num" =~ ^[0-9]+$ ]]; then
        echo "Warning: '$num' is not a valid number, skipping."
        continue
    fi
    
    index=$((num - 1))
    if [ $index -lt 0 ] || [ $index -ge ${#contexts[@]} ]; then
        echo "Warning: Number $num is out of range, skipping."
        continue
    fi
    
    context="${contexts[$index]}"
    
    if [ "$context" = "$current_context" ]; then
        echo "Warning: Cannot delete current context '$context', skipping."
        continue
    fi
    
    contexts_to_delete+=("$context")
done

# Confirm deletion
if [ ${#contexts_to_delete[@]} -eq 0 ]; then
    echo "No valid contexts to delete."
    exit 0
fi

echo
echo "Contexts to delete:"
for context in "${contexts_to_delete[@]}"; do
    echo "  - $context"
done
echo

read -p "Are you sure you want to delete these contexts? (y/N): " confirm

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    for context in "${contexts_to_delete[@]}"; do
        kubectl config delete-context "$context"
        if [ $? -eq 0 ]; then
            echo "✓ Deleted: $context"
        else
            echo "✗ Failed to delete: $context"
        fi
    done
else
    echo "Deletion cancelled."
fi
